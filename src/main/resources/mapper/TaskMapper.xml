<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.winkel.qualityevaluation.dao.TaskDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.winkel.qualityevaluation.entity.task.EvaluateTask">
        <id column="evaluate_task_id" property="id"/>
        <result column="school_code" property="schoolCOde"/>
        <result column="evaluate_task_name" property="name"/>
        <result column="evaluate_id" property="evaluateId"/>
        <result column="evaluate_task_start_time" property="startTime"/>
        <result column="evaluate_task_end_time" property="endTIme"/>
        <result column="evaluate_task_content" property="content"/>
        <result column="task_cycle" property="cycle"/>
        <result column="task_status" property="status"/>
        <result column="task_type" property="type"/>
        <result column="task_is_locked" property="isLocked"/>
    </resultMap>

    <update id="startCycle" parameterType="java.lang.String">
        update evaluatecycle
        set cycle_current = cycle_current + 1
        where cycle_county_location_code = #{locationCode}
    </update>

    <select id="selectCurrentCycle" resultType="java.lang.Integer">
        select cycle_current
        from evaluatecycle
        where cycle_county_location_code = #{locationCode}
    </select>

    <select id="selectTaskIdByUserId" resultType="java.lang.Integer">
        select evaluate_task_id
        from evaluatetask,
             user,
             tschool,
             evaluatecycle
        where user.id = #{id}
          and user.school_code = evaluatetask.school_code = tschool.school_code
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code
          and evaluatetask.task_cycle = evaluatecycle.cycle_current
          and evaluatetask.task_type = #{type}
    </select>

    <select id="selectTaskByUserId" resultType="com.winkel.qualityevaluation.entity.task.EvaluateTask">
        select evaluatetask.task_status, evaluatetask.evaluate_task_id, evaluatetask.school_code, evaluatetask.task_cycle
        from evaluatetask,
             user,
             tschool,
             evaluatecycle
        where user.id = #{id}
          and user.school_code = evaluatetask.school_code = tschool.school_code
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code
          and evaluatetask.task_cycle = evaluatecycle.cycle_current
          and evaluatetask.task_type = #{type}
    </select>


</mapper>
