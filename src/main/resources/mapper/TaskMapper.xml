<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.winkel.qualityevaluation.dao.TaskDao">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.winkel.qualityevaluation.entity.task.EvaluateTask">
        <id column="evaluate_task_id" property="id"/>
        <result column="school_code" property="schoolCode"/>
        <result column="evaluate_task_name" property="name"/>
        <result column="evaluate_id" property="evaluateId"/>
        <result column="evaluate_task_start_time" property="startTime"/>
        <result column="evaluate_task_end_time" property="endTIme"/>
        <result column="evaluate_task_content" property="content"/>
        <result column="task_cycle" property="cycle"/>
        <result column="task_status" property="status"/>
        <result column="task_type" property="type"/>
        <result column="task_is_locked" property="isLocked"/>
    </resultMap>

    <resultMap id="schoolTaskMap" type="com.winkel.qualityevaluation.pojo.vo.SchoolTaskVo">
        <result column="school_code" property="schoolCode"/>
        <result column="school_name" property="schoolName"/>
        <result column="evaluate_task_id" property="taskId"/>
        <result column="evaluate_task_start_time" property="startDate"/>
        <result column="task_status" property="taskStatus"/>
    </resultMap>

    <resultMap id="cycleMap" type="com.winkel.qualityevaluation.pojo.vo.CycleVo">
        <result column="provinceName" property="provinceName"/>
        <result column="countyName" property="countyName"/>
        <result column="cycle_current" property="currentCycle"/>
        <result column="code" property="locationCode"/>
    </resultMap>

    <update id="startCycle" parameterType="java.lang.String">
        update evaluatecycle
        set cycle_current = cycle_current + 1
        where cycle_county_location_code = #{locationCode}
    </update>

    <select id="selectCurrentCycle" resultType="java.lang.Integer">
        select cycle_current
        from evaluatecycle
        where cycle_county_location_code = #{locationCode}
    </select>

    <select id="selectTaskIdByUserIdAndType" resultType="java.lang.Integer">
        select evaluate_task_id
        from evaluatetask,
             user,
             tschool,
             evaluatecycle
        where user.id = #{id}
          and user.school_code = evaluatetask.school_code = tschool.school_code
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code
          and evaluatetask.task_cycle = evaluatecycle.cycle_current
          and evaluatetask.task_type = #{type}
    </select>

    <!--    <select id="selectTaskByUserId" resultType="com.winkel.qualityevaluation.entity.task.EvaluateTask">-->
    <!--        select evaluatetask.evaluate_task_id-->
    <!--        from evaluatetask,-->
    <!--             user,-->
    <!--             tschool,-->
    <!--             evaluatecycle-->
    <!--        where user.id = #{id}-->
    <!--          and user.school_code = evaluatetask.school_code = tschool.school_code-->
    <!--          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code-->
    <!--          and evaluatetask.task_cycle = evaluatecycle.cycle_current-->
    <!--          and evaluatetask.task_type = #{type}-->
    <!--    </select>-->


    <select id="selectFinishedTaskIdByCountyAdminId" resultType="java.lang.Integer">
        select evaluatetask.evaluate_task_id
        from evaluatetask,
             user,
             tschool,
             evaluatecycle
        where user.id = #{id}
          and evaluatecycle.cycle_county_location_code = user.location_code
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code
          and evaluatetask.school_code = tschool.school_code
          and evaluatetask.task_cycle = evaluatecycle.cycle_current
          and evaluatetask.task_type in (2, 3)
          and evaluatetask.task_status = 4
    </select>


    <select id="selectFinishedTaskIdByCityAdminId" resultType="java.lang.Integer">
        select evaluatetask.evaluate_task_id
        from evaluatetask,
             user,
             tschool,
             evaluatecycle
        where user.id = #{id}
          and CONCAT(LEFT(tschool.school_location_code, 4), '00000000') = user.location_code
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code
          and evaluatetask.school_code = tschool.school_code
          and evaluatetask.task_cycle = evaluatecycle.cycle_current
          and evaluatetask.task_type = 4
          and evaluatetask.task_status = 4
    </select>

    <select id="selectFinishedTaskIdByProvinceAdminId" resultType="java.lang.Integer">
        select evaluatetask.evaluate_task_id
        from evaluatetask,
             user,
             tschool,
             evaluatecycle
        where user.id = #{id}
          and CONCAT(LEFT(tschool.school_location_code, 2), '0000000000') = user.location_code
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code
          and evaluatetask.school_code = tschool.school_code
          and evaluatetask.task_cycle = evaluatecycle.cycle_current
          and evaluatetask.task_type = 5
          and evaluatetask.task_status = 4
    </select>

    <!--    <select id="selectTaskIdByAdminId" resultType="java.lang.Integer">-->
    <!--        select evaluatetask.evaluate_task_id-->
    <!--        from evaluatetask,-->
    <!--        user,-->
    <!--        tschool,-->
    <!--        evaluatecycle,-->
    <!--        user_authority-->
    <!--        where user.id = #{id}-->
    <!--        and user_authority.user_id = user.id-->
    <!--        and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = evaluatecycle.cycle_county_location_code-->
    <!--        and evaluatetask.task_cycle = evaluatecycle.cycle_current-->
    <!--        and evaluatetask.school_code = tschool.school_code-->
    <!--        and evaluatetask.task_status = 4-->
    <!--        <choose>-->
    <!--            <when test="user_authority.authority_id == 1">-->
    <!--                and evaluatecycle.cycle_county_location_code = user.location_code-->
    <!--                and evaluatetask.task_type in (2, 3)-->
    <!--            </when>-->
    <!--            <when test="user_authority.authority_id == 2">-->
    <!--                and CONCAT(LEFT(tschool.school_location_code, 4), '00000000') = user.location_code-->
    <!--                and evaluatetask.task_type = 4-->
    <!--            </when>-->
    <!--            <when test="user_authority.authority_id == 3">-->
    <!--                and CONCAT(LEFT(tschool.school_location_code, 2), '0000000000') = user.location_code-->
    <!--                and evaluatetask.task_type = 5-->
    <!--            </when>-->
    <!--            <otherwise>-->

    <!--            </otherwise>-->
    <!--        </choose>-->
    <!--    </select>-->


    <select id="selectTaskByCountycodeAndTasktypeAndStatus" resultMap="BaseResultMap">
        select distinct evaluatetask.evaluate_task_id,
                        evaluatetask.school_code,
                        evaluatetask.evaluate_task_end_time,
                        evaluatetask.task_cycle,
                        evaluatetask.task_status,
                        evaluatetask.task_type
        from user,
             evaluatetask,
             tschool,
             evaluatecycle as cycle
        where evaluatetask.task_status = #{status}
          and evaluatetask.task_type = #{tasktype}
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = #{countycode}
          and evaluatetask.task_cycle = cycle.cycle_current
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = cycle.cycle_county_location_code
    </select>

    <select id="selectTaskByCitycodeAndTasktypeAndStatus" resultMap="BaseResultMap">
        select distinct evaluatetask.evaluate_task_id,
                        evaluatetask.school_code,
                        evaluatetask.evaluate_task_end_time,
                        evaluatetask.task_cycle,
                        evaluatetask.task_status,
                        evaluatetask.task_type
        from user,
             evaluatetask,
             tschool,
             evaluatecycle as cycle
        where evaluatetask.task_status = #{status}
          and evaluatetask.task_type = #{tasktype}
          and CONCAT(LEFT(tschool.school_location_code, 4), '00000000') = #{citycode}
          and evaluatetask.task_cycle = cycle.cycle_current
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = cycle.cycle_county_location_code
    </select>

    <select id="selectTaskByProvincecodeAndTasktypeAndStatus" resultMap="BaseResultMap">
        select distinct evaluatetask.evaluate_task_id,
                        evaluatetask.school_code,
                        evaluatetask.evaluate_task_end_time,
                        evaluatetask.task_cycle,
                        evaluatetask.task_status,
                        evaluatetask.task_type
        from user,
             evaluatetask,
             tschool,
             evaluatecycle as cycle
        where evaluatetask.task_status = #{status}
          and evaluatetask.task_type = #{tasktype}
          and CONCAT(LEFT(tschool.school_location_code, 2), '0000000000') = #{provincecode}
          and evaluatetask.task_cycle = cycle.cycle_current
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = cycle.cycle_county_location_code
    </select>

    <select id="selectCountyTask" resultMap="BaseResultMap">
        select distinct evaluatetask.evaluate_task_id,
                        evaluatetask.school_code,
                        evaluatetask.evaluate_task_end_time,
                        evaluatetask.task_cycle,
                        evaluatetask.task_status,
                        evaluatetask.task_type
        from evaluatetask,
             tschool,
             evaluatecycle as cycle
        where CONCAT(LEFT(tschool.school_location_code, 6), '000000') = #{locationCode}
          and tschool.school_code = evaluatetask.school_code
          and CONCAT(LEFT(tschool.school_location_code, 6), '000000') = cycle.cycle_county_location_code
          and evaluatetask.task_cycle = cycle.cycle_current
    </select>

    <!--    <select id="selectCityTask" resultMap="BaseResultMap">-->
    <!--        select distinct evaluatetask.evaluate_task_id,-->
    <!--                        evaluatetask.school_code,-->
    <!--                        evaluatetask.evaluate_task_end_time,-->
    <!--                        evaluatetask.task_cycle,-->
    <!--                        evaluatetask.task_status,-->
    <!--                        evaluatetask.task_type-->
    <!--        from evaluatetask,-->
    <!--             tschool-->
    <!--        where CONCAT(LEFT(tschool.school_location_code, 4), '00000000') = #{locationCode}-->
    <!--          and tschool.school_code = evaluatetask.school_code-->
    <!--    </select>-->

    <!--    <select id="selectProvinceTask" resultMap="BaseResultMap">-->
    <!--        select distinct evaluatetask.evaluate_task_id,-->
    <!--                        evaluatetask.school_code,-->
    <!--                        evaluatetask.evaluate_task_end_time,-->
    <!--                        evaluatetask.task_cycle,-->
    <!--                        evaluatetask.task_status,-->
    <!--                        evaluatetask.task_type-->
    <!--        from evaluatetask,-->
    <!--             tschool-->
    <!--        where CONCAT(LEFT(tschool.school_location_code, 2), '0000000000') = #{locationCode}-->
    <!--          and tschool.school_code = evaluatetask.school_code-->
    <!--    </select>-->

    <select id="listAllBySort" resultMap="schoolTaskMap">
        SELECT DISTINCT tschool.school_code,
        tschool.school_name,
        task.evaluate_task_id,
        task.evaluate_task_start_time,
        task_status
        FROM tschool,
        evaluatetask AS task,
        evaluatesubmit AS submit,
        evaluatecycle AS cycle
        WHERE tschool.school_code = task.school_code

        AND task_type = #{schoolTaskDTO.taskType}
        AND task_status = #{schoolTaskDTO.taskStatus}
        AND submit.evaluate_task_id = task.evaluate_task_id
        <choose>
            <when test="schoolTaskDTO.countyCode != null">
                and concat(left(tschool.school_location_code,6),'000000')= #{schoolTaskDTO.countyCode}
            </when>
            <when test="schoolTaskDTO.cityCode != null">
                and concat(left(tschool.school_location_code,4),'00000000')= #{schoolTaskDTO.cityCode}
            </when>
            <when test="schoolTaskDTO.provinceCode != null">
                and concat(left(tschool.school_location_code,2),'0000000000')= #{schoolTaskDTO.provinceCode}
            </when>
        </choose>
        <choose>
            <when test="schoolTaskDTO.isPublic eq 1">
                and tschool.school_host_code not like '9%'
            </when>
            <when test="schoolTaskDTO.isPublic eq 0">
                and tschool.school_host_code like '9%'
            </when>
        </choose>
        <choose>
            <when test="schoolTaskDTO.isCity eq 1">
                and tschool.school_location_type_code like '1%'
            </when>
            <when test="schoolTaskDTO.isCity eq 0">
                and tschool.school_location_type_code like '2%'
            </when>
        </choose>
        <choose>
            <when test="schoolTaskDTO.isGb eq 1">
                and tschool.is_generally_beneficial = 1
            </when>
            <when test="schoolTaskDTO.isGb eq 0">
                and tschool.is_generally_beneficial = 0
            </when>
        </choose>
        <trim suffixOverrides=",">
            <if test="schoolTaskDTO.startDate != null">
                and DATE_FORMAT(evaluate_task_start_time,'%Y-%m-%d') =
                DATE_FORMAT(#{schoolTaskDTO.startDate},'%Y-%m-%d')
            </if>
            <if test="schoolTaskDTO.keyName != null">
                <bind name="keyName" value="'%' +schoolTaskDTO.keyName+'%'"/>
                and tschool.school_name like #{keyName}
            </if>
            <if test="schoolTaskDTO.schoolCode != null">
                <bind name="schoolCode" value="'%' +schoolTaskDTO.schoolCode+'%'"/>
                and tschool.school_code like #{schoolCode}
            </if>
        </trim>
        limit #{schoolTaskDTO.currentPage}, #{schoolTaskDTO.pageSize}
    </select>

    <select id="selectLastSubmitTimeByTaskId" resultType="java.time.LocalDateTime">
        select max(submit.submit_time)
        from evaluatesubmit as submit
        where submit.evaluate_task_id = #{taskId}
    </select>

    <select id="selectFirstSubmitTimeByTaskId" resultType="java.time.LocalDateTime">
        select min(submit.submit_time)
        from evaluatesubmit as submit
        where submit.evaluate_task_id = #{taskId}
    </select>

    <select id="selectFileNameBySchoolcodeAndType" resultType="java.lang.String">
        select file.report_file_name
        from evaluatereportfiles as file,
        evaluatetask as task,
        tschool as school,
        evaluatecycle as cycle
        where file.task_id = task.evaluate_task_id
        AND CONCAT(LEFT(school.school_location_code, 6), '000000') = cycle.cycle_county_location_code
        AND task.task_cycle = cycle.cycle_current
        and school.school_code = task.school_code
        and task.task_type = #{type}
        and task.school_code in
        <foreach collection="schoolCodes" index="index" item="schoolCode" open="(" separator="," close=")">
            #{schoolCode,jdbcType=VARCHAR}
        </foreach>
    </select>

    <select id="getTaskIdByBySchoolcodeAndType" resultType="java.lang.Integer">
        select distinct task.evaluate_task_id
        from evaluatereportfiles as file,
             evaluatetask as task,
             tschool as school,
             evaluatecycle as cycle
        where CONCAT(LEFT(school.school_location_code, 6), '000000') = cycle.cycle_county_location_code
          AND task.task_cycle = cycle.cycle_current
          and school.school_code = task.school_code
          and task.task_type = #{type}
          and task.school_code = #{schoolCode}
    </select>

    <select id="listCycleByLocationAndRegionType" resultMap="cycleMap">
        select location.name as countyName, location.code, cycle.cycle_current
        from location,
        evaluatecycle as cycle
        where location.code = cycle.cycle_county_location_code and
        <choose>
            <when test="dto.type eq 1">
                CONCAT(LEFT(cycle.cycle_county_location_code, 2), '0000000000') = #{dto.locationCode}
            </when>
            <when test="dto.type eq 2">
                CONCAT(LEFT(cycle.cycle_county_location_code, 4), '00000000') = #{dto.locationCode}
            </when>
            <when test="dto.type eq 3">
                CONCAT(LEFT(cycle.cycle_county_location_code, 6), '000000') = #{dto.locationCode}
            </when>
        </choose>
    </select>


</mapper>
